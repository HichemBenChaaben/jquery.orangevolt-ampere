<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"> 
	<head>  
		<!--
		  Copyright (c) 2011 Lars Gersmann (lars.gersmann@gmail.com, http://orangevolt.blogspot.com)
		  Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
		  and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
		-->
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=7,chrome=1; IE=9" />
	
		<link href="js/jquery-ui-1.9m3/themes/base/jquery-ui.css" media="screen" rel="stylesheet" type="text/css" />
		<link href="js/jquery-plugins/ampere/jquery.ampere.css" media="screen" rel="stylesheet" type="text/css" />
		
		<script type="text/javascript" src="js/modernizr-1.6.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9m3/jquery-1.4.4.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9m3/ui/jquery-ui.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9m3/ui/i18n/jquery-ui-i18n.js"></script>
		<script type="text/javascript" src="js/json2.js"></script>
		<script type="text/javascript" src="js/jquery-plugins/jquery.tmpl.js"></script>
		
		<script type="text/javascript" src="js/jquery-plugins/jquery.datalink.js"></script>
		<script type="text/javascript" src="js/jquery-plugins/jquery.globalization.js"></script>
		
		
		<script id="testTemplate" type="text/x-jquery-tmpl">
  			<form class="ampere view" style="width:300px;height:400px;position:relative">
				<p>
					<label for="email">Email :</label>
					<input type="text" id="email" name="email" value="${email}"/>				
				</p>
				
				<p>
					<input 
						type="checkbox" 
						id="state" 
						name="state" 
						{{if state}} checked="checked" {{/if}} 
					/>
					<label for="state">State</label>	
				</p>

				<p>
					<input 
						type="checkbox" 
						id="state2" 
						name="state2" 
						{{if state2}} checked="checked" {{/if}} 
					/>
					<label for="state2">MyState</label>	
				</p>

				<p>
					<label for="gender">Gender:</label>	
					<select
						id="gender" 
						name="gender" 
					>
						<option value="male">Male</option>
						<option {{if gender=='female'}} selected="selected" {{/if}} value="female">Female</option>
					</select>					
				</p>

				<p>
					<label for="interests">Interests:</label>	
					<select
						id="interests" 
						name="interests"
						multiple="multiple"
					>
						<option value="swimming">Swimming</option>
						<option value="boxing">Boxing</option>
						<option value="fighting">Fighting</option>
						<option value="watch_tv">Watching TV</option>
					</select>					
				</p>

				<p>
					<input 
						type="radio" 
						id="available" 
						name="availability" 
						value="available"
						{{if availability=='available'}} checked="checked" {{/if}} 
					/>
					<label for="available">Available</label>	
					<input 
						type="radio" 
						id="busy" 
						name="availability" 
						value="busy"
						{{if availability=='busy'}} checked="checked" {{/if}} 
					/>
					<label for="available">Busy</label>
					<input 
						type="radio" 
						id="somewhere_else" 
						name="availability" 
						value="somewhere_else"
						{{if availability=='somewhere_else'}} checked="checked" {{/if}} 
					/>
					<label for="available">Somewhere else</label>
				</p>

				<p>
					<label for="notes">Notes:</label>	
					<textarea id="notes" name="notes">${notes}</textarea>					
				</p>

				<div style="position:absolute;bottom:0;right:0;left:0;padding: 4px 4px;" class="ui-widget-header ui-corner-all">
					<div class="actions" style="float:right">
						{{each actions}}						
						<button 
							type="button" 
							name="${$index}" 
							class="action button" 
							style="text-transform:capitalize;"
							{{if $value.condition.call( $data)===false}} disabled="disabled" {{/if}}
						>
							${$index}
						</button>
						{{/each}}
					</div>
				</div>
			</form>
		</script>
		
		<script type="text/javascript">
			$(window).ready( function() {
				$( '.ampere.view .actions >.action').live( 'click', function() {
					var tmplItem = $.tmplItem( this);
					if( tmplItem && tmplItem.data && tmplItem.data.actions) {
						if( tmplItem.data.actions[ this.name].condition.call( tmplItem.data)!==false) {
							tmplItem.data.actions[ this.name].fn.call( tmplItem.data);
						}							
					}
				});
				
				window.data = {
					email	: 'lars.gersmann@reinboeng.com',
					state2  : true,
					state   : false,
					gender  : 'female',
					interests:'boxing',
					availability : 'busy',
					notes   : 'hello there !!',
					actions : {
						one : { 
							fn : function() {
								alert( 'one clicked');
							}, 
							condition : function() {
								return this.state; 
							}
						},
						two : {
							fn : function() {
								alert( 'two clicked');
							},
							condition : function() {
								return this.state2; 
							}
						}
					}
				};
				
				var container = $( "#testTemplate" ).tmpl( data).appendTo( 'body');
				
				function checkbox2boolean() {
					return {
						convert     : function( value, source, target) {
							$( target).data( source.name, source.checked);
						},
						convertBack : function( value, source, target) {
							target.checked = source[ target.name];
							//$( target).trigger( 'change');
						}
					};
				}
				
				function radio() {
					return {
						convert     : function( value, source, target) {
							var radios = source.form[source.name];
							for( var i=0; i<radios.length; i++) {
								if( radios[i].checked) {
									$( target).data(source.name, value);
									break;
								} 
							} 
						},
						convertBack : function( value, source, target) {
							var radios = target.form[ target.name];
							for( var i=0; i<radios.length; i++) {
								if( radios[ i].value==source[ target.name]) {
									radios[ i].checked = true;
									break;
								} 
							}
						}
					};
				}
				
				function multipleSelect2array() {
					return {
						convert     : function( value, source, target) {
							$( target).data( source.name, $.makeArray( $( source).val()));
						},
						convertBack : function( value, source, target) {
							$( target).val( source[ target.name]);
							//$( target).trigger( 'change');
						}
					};
				}
				
				$( container).link( window.data, {
					email  : 'email',	
					state  : checkbox2boolean(),
					state2 : checkbox2boolean(),
					gender : 'gender',
					availability : radio(),
					interests : multipleSelect2array(),
					notes  : 'notes',
				}).change( function( event) {
					console.log( event.target.name + ' was changed');
					console.dir( window.data);
					var tmplItem = $.tmplItem( event.target);
					
					container.find( '.actions .action').each( function() {
						if( tmplItem && tmplItem.data && tmplItem.data.actions) {
							event.target.form[ this.name].disabled = tmplItem.data.actions[ this.name].condition.call( tmplItem.data)===false;
						}
					})
				}).blur( function() {
					console.log( 'blur');
				});
				
				//container.find( 'button.action').button();
			});
			//window.actions = 
		</script>
    </head>
    <body>
    	
    </body>
</html>
