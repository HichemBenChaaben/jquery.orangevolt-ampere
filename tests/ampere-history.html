<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=7" />
<title>query.orangevolt.history testcase</title>

<link type="text/css" rel="stylesheet" media="screen" href="testsuite.css"/>
<link type="text/css" rel="stylesheet" media="screen" href="../lib/jquery_mobile/jquery.mobile-1.0a2.css"/>

<script language="javascript" src="../lib/jquery-1.4.4.js"></script>
<script language="javascript" src="../lib/jquery_mobile/jquery.mobile-1.0a2.js"></script>
<script language="javascript" src="lib/jqUnit.js"></script>
<script language="javascript" src="../lib/jquery.orangevolt-history.js"></script>

<script type="text/javascript">
with( jqUnit) {
	module( 'jquery.orangevolt.history');

	var mockObject = {
		value : ''
	}; 
	
	function mockAction( value, undoable) {		
		return function() {
			var undoAction = undoable ? mockAction( mockObject.value, undoable) : undefined;
			console.log( 'set value = ', value);
			mockObject.value = value;
			return undoAction;
		};
	}
	
	test( 'simple history', function() {
		var history = $.orangevolt.history();
		equals( false, history.canUndo());
		equals( false, history.canRedo());
		
		history.redo( mockAction( 'a', true));
		equals( true, history.canUndo());
		equals( false, history.canRedo());
		equals( 'a', mockObject.value);

		history.undo();
		equals( false, history.canUndo());
		equals( true, history.canRedo());
		equals( '', mockObject.value);
		
		history.redo();
		equals( true, history.canUndo());
		equals( false, history.canRedo());
		equals( 'a', mockObject.value);

		history.undo();
		equals( false, history.canUndo());
		equals( true, history.canRedo());
		equals( '', mockObject.value);
		
		history.reset();
		equals( false, history.canUndo());
		equals( false, history.canRedo());
	});

	test( 'history', function() {
		var history = $.orangevolt.history();
		equals( false, history.canUndo());
		equals( false, history.canRedo());
		
		history.redo( mockAction( 'a', true));
		equals( true, history.canUndo());
		equals( false, history.canRedo());
		equals( 'a', mockObject.value);

		history.redo( mockAction('b'));
		equals( false, history.canUndo());
		equals( false, history.canRedo());
		equals( 'b', mockObject.value);

		history
		.redo( mockAction('c', true))
		.redo( function() {
			mockObject.value = 'd';
			return function() {
				mockObject.value = 'e';
			};
		})
		.redo( mockAction('f', true));
		equals( 3, history.canUndo());
		equals( false, history.canRedo());
		equals( 'f', mockObject.value);

		history.undo();
		equals( 2, history.canUndo());
		equals( true, history.canRedo());
		equals( 'd', mockObject.value);		

		history.undo();
		equals( 1, history.canUndo());
		equals( false, history.canRedo());
		equals( 'e', mockObject.value);

		history.undo();
		equals( 0, history.canUndo());
		equals( true, history.canRedo());
		equals( 'b', mockObject.value);

		history.redo();
		equals( true, history.canUndo());
		equals( false, history.canRedo());
		equals( 'e', mockObject.value);

		history.undo();
		equals( false, history.canUndo());
		equals( true, history.canRedo());
		equals( 'b', mockObject.value);	 	
	});

	test( 'history combine', function() {
		var history = $.orangevolt.history();

		history.redo( mockAction( 'a', true));
		history.redo( mockAction( '1', true), mockAction( '2', false), mockAction( '3', true));
		equals( false, history.canUndo());
		equals( false, history.canRedo());
		equals( '3', mockObject.value);
		history.redo( mockAction( '4', true), mockAction( '5', true), mockAction( '6', true));
		equals( true, history.canUndo());
		equals( false, history.canRedo());
		equals( '6', mockObject.value);
		history.redo( mockAction( '7', true));
		equals( 2, history.canUndo());
		equals( false, history.canRedo());
		equals( '7', mockObject.value);
		history.undo();
		equals( true, history.canUndo());
		equals( true, history.canRedo());
		equals( '6', mockObject.value);
		history.redo();
		equals( 2, history.canUndo());
		equals( false, history.canRedo());
		equals( '7', mockObject.value);
		history.undo().undo();
		equals( false, history.canUndo());
		equals( 2, history.canRedo());
		equals( '3', mockObject.value);
	});
}
</script>

</head>
<body>
	<pre>
/* 
 * Copyright (c) 2011 Lars Gersmann (lars.gersmann@gmail.com, http://orangevolt.blogspot.com)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 */	
	</pre>

	<h3>test results</h3>

	 <!-- Test HTML -->
    <div id="main" style="display: none;">
      <form id="test-form">
        <input/>
      </form>
      <div id="ajax">
        
      </div>
    </div>
    <ol id="tests"></ol>
</body>
</html>