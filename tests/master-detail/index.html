<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
	<!--
	  Copyright (c) 2011 Lars Gersmann (lars.gersmann@gmail.com, http://orangevolt.blogspot.com)
	  Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
	  and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
	--> 
	<head>  
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=7,chrome=1; IE=9" />
		
		<title>Orangevolt Ampere master/detail example</title>
		
		<script type="text/javascript" src="../../lib/jquery-1.5.1.js"></script>
		<script type="text/javascript" src="../../lib/jquery/plugins/jquery.defer.js"></script>
		<script type="text/javascript" src="../../src/jquery.ampere-defer.js"></script>
		
		<script id="introduction" type="text/x-jquery-tmpl">
			<div style="padding:10px"> 
				<p>
					This application shows the a master/detail scenario implemented using Ampere.
					<p>
					{{transition( state.transitions.master)}}
					</p>
				</p>
			</div>
		</script>
		<script id="master" type="text/x-jquery-tmpl">
			<dl style="width:50%;min-width:400px">
				{{field({ label:'Persons'})}}
					{{group({ orientation : 'vertical'})}} 
						{{each state.module.persons}}
							{{radio({name:'selected', value:$index, label:$value.name + ' ' + $value.familyname})}}
						{{/each}}
					{{/group}}
					<p class="description">
						{{transition( state.transitions.add)}} or select a person to continue. 
					</p>	
				{{/field}}
			</dl>
		</script>
		<script id="detail" type="text/x-jquery-tmpl">
			<dl>
				{{field({ label:'Name'})}}
					{{text({ name:'name', 		value:state.get('name')})}}
				{{/field}}
				{{field({ label:'Familyname'})}}
					{{text({ name:'familyname', value:state.get('familyname')})}}
				{{/field}}
				{{field({ label:'Email'})}}
					{{text({ name:'email', 		value:state.get('email')})}}
				{{/field}}
			</dl>
		</script>
		<script id="remove" type="text/x-jquery-tmpl">
			<div style="padding:10px"> 
				<p>
					Are you really sure to remove person 
					<strong> 
						${ state.module.persons[ state.module.states.master.selected].name} ${ state.module.persons[ state.module.states.master.selected].familyname}
					</strong>
					?
				</p>
			</div>
		</script>
		
		<script type="text/javascript">
	
		$.ampere( function() {
			$.ampere.module( function masterdetail() {
				this.persons = this.options( 'persons');
				
				this
				.state( function introduction() {})
				.state( function master() 		{
					this.selected = -1;
				})
				.state( function detail() 		{
					this.get = function( property) {
						return this.module.persons[ this.module.states.master.selected][property];
					}
				})
				.state( function remove() 		{})
				.state( function add() 			{
					this.view( 'detail');
					
					this.get = function( property) {
						return ''; 
					}
				});
				
				this.states.introduction.transition( this.states.master, {
					label : 'Demo',
					type  : 'manual' 
				});
				
				this.states.master
				.transition( this.states.detail, {
					disabled : function() {
						return this.state.selected==-1;
					}
				})
				.transition( this.states.add, {
					type   : 'manual'/*,
					action : function() {
						this.target.name = '';
						this.target.familyname = '';
						this.target.email = '';
					}*/
				});
				
				this.states.add
				.transition( this.states.master, {
					label    : 'Cancel',
					icon  	 : false
				})
				.transition( this.states.master, {
					name   : 'add',
					label  : 'Ok',
					icon   : false,
					action : this.states.add.action( function() {
						var selected = this.state.module.states.master.selected;
						var index = Math.max( selected, 0);
						
						return function() {
							this.state.module.states.master.person = {
								name		: this.state.name,
								familyname  : this.state.familyname,
								email		: this.state.email 
							};
							
							this.state.module.persons.splice( index, 0, this.state.module.states.master.person);
							this.state.module.states.master.selected = index;
							
							return function() {
								this.state.module.persons.splice( index, 1);
								this.state.module.states.master.selected = selected;
							};
						};
					}),
					disabled : function() {
						return !($.ampere.validation.conditions.isEmail( this.state.email)
							&&	/^[a-z](.*)$/i.test( this.state.name)
							&&	/^[a-z](.*)$/i.test( this.state.familyname));
					}
				})
				
				this.states.detail
				.transition( this.states.master, {
					label    : 'Back',
					icon  	 : 'ui-icon-triangle-1-w'
				})
				.transition( this.states.master, {
					name 	 : 'update',
					label 	 : 'Update',
					icon  	 : 'ui-icon-disk',
					disabled : function() {
						var person   = this.state.module.persons[ this.state.module.states.master.selected];
						
						var nothingChanged = $.ampere.util.equals( person, { name:this.state.name, familyname:this.state.familyname, email:this.state.email});
						return nothingChanged 
							|| !(
								$.ampere.validation.conditions.isEmail( this.state.email)
								&&	/^[a-z](.*)$/i.test( this.state.name)
								&&	/^[a-z](.*)$/i.test( this.state.familyname)
							);
					},
					action   : this.states.detail.action( function() {
						var person   = this.state.module.persons[ this.state.module.states.master.selected];
						var values   = $.extend( {}, person);
						
						return function() {
							person.name = this.state.name;
							person.familyname = this.state.familyname;
							person.email = this.state.email;

							return function() {
								$.extend( person, values);
							};
						};
					}) 
				})
				.transition( this.states.remove, {
					icon  	 : 'ui-icon-closethick'
				});
				
				this.states.remove
				.transition( this.states.master, {
					label    : 'Cancel',
					icon  	 : false
				})
				.transition( this.states.master, {
					name 	 : 'remove', 
					label    : 'Ok',
					icon  	 : false,
					action   : this.states.remove.action( function() {
						var selected = this.state.module.states.master.selected;
						var person   = this.state.module.persons[ selected];
						
						return function() {
							this.state.module.persons.splice( selected, 1);
							this.state.module.states.master.selected = -1;

							return function() {
								this.state.module.persons.splice( selected, 0, person);
								this.state.module.states.master.selected = selected;
							};
						};
					})
				});
				
				for( var name in this.states) {
					if( name!='introduction') {
						this.states[name].transition( this.states.introduction, {
							group 	: '$global',
							icon 	: 'ui-icon-home'
						});
					}
				}
			}, 
			{ 
				label    : $( 'head >title').text(),
				state 	 : 'introduction',
				label    : $('head >title').text(),
				about    : $('<div><a target="_blank" href="https://github.com/lgersman/jquery.orangevolt-ampere">Ampere</a> - CopyrightÂ© 2011 by <a target="_blank" href="http://www.orangevolt.com">Orangevolt</a>.</div>')
			});
			
			$( 'body').module( 'masterdetail', { persons : [
				{ name : 'Lars', familyname : 'Gersmann', email : 'lars.gersmann@gmail.com'},
				{ name : 'Nico', familyname : 'Brehm', 	  email : 'nbrehm@repugraph.de'}
			]});
		},
		{ 
            debug : true,
            /*'jquery-ui/themes/base/jquery-ui.css',*/
            'jquesdfsdfry-ui-theme'  : 
            	// '//ajax.googleapis.com/ajax/libs/jqueryui/1.8.11/themes/redmond/jquery.ui.all.css'
				  'http://lion/dev/guilib/src/css/themes/wsc/_default_jquery/jquery-ui-1.8.4.patched.css'
        }
		);
		</script>
	</head>
	<body class="portal">
		<div class="ui-widget-overlay">
			<div class="ampere placeholder"/>
		</div>
	</body>
</html>
